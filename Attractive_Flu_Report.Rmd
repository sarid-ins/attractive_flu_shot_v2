---
title: "The Attractive Flu Shot 2019 - Summary Report"
author: "Amnon Maltz and Adi Sarid"
date: "2019-10-07"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background

The following report summarizes the analysis of an "attractive flu shot" experiment. This is merely a technical report including all the data import, transformations, modelling, visualization. 

The report is built in the spirit of "reproduceable research", i.e., assuming a similar data format, all the statistical procedures can be performed in standard packages available in R.

```{r data import}

suppressMessages(suppressWarnings(library(tidyverse)))

# To use the saridr package use:
# devtools::install_github("sarid-ins/saridr")

# some responses are in Hebrew - making sure encoding is read correctly.
suppressMessages(Sys.setlocale("LC_ALL", "Hebrew")) 


flu_data <- read_csv("data/flu_data_final.csv") %>% 
  mutate(treatment = fct_relevel(treatment, "Control", "Recommendation", "Stock", "Cost", "Benefit")) %>% 
  mutate(age_group = cut(age, breaks = c(0, 17.9, 29, 39, 49, 59, 100)))

```

## Demographics (Table 1)

The demographics of participants

```{r demographics}
gender <- flu_data %>% 
  group_by(treatment) %>% 
  saridr::prop(gender) %>% 
  spread(treatment, prop) %>% 
  filter(gender == "Female") %>% 
  mutate(Demography = paste0("% ", gender)) %>% 
  select(-gender) %>% 
  mutate_if(is.numeric, ~{paste0(round(.*100,1), "%")})

age <- flu_data %>% 
  group_by(treatment) %>% 
  summarize(mean = mean(age, na.rm = T),
            sd = sd(age, na.rm = T)) %>% 
  mutate(tbl_value = paste0(round(mean, 1), " (", round(sd, 1), ")")) %>% 
  ungroup() %>%
  select(treatment, tbl_value) %>% 
  spread(treatment, tbl_value) %>% 
  mutate(Demography = "Age mean (sd)")

income <- flu_data %>% 
  group_by(treatment) %>% 
  saridr::prop(income) %>% 
  spread(treatment, prop) %>% 
  slice(c(2, 4, 3, 5, 6, 1)) %>% 
  mutate_if(is.numeric, ~{paste0(round(.*100,1), "%")}) %>% 
  rename(Demography = income)
  

education <- flu_data %>% 
  group_by(treatment) %>% 
  saridr::prop(education) %>% 
  spread(treatment, prop) %>% 
  slice(c(1:2, 4:5, 3, 6)) %>% 
  mutate_if(is.numeric, ~{paste0(round(.*100,1), "%")}) %>% 
  rename(Demography = education) %>% 
  mutate(Demography = fct_explicit_na(Demography))

demographics_latex_table <- bind_rows(gender,
                                      age,
                                      income,
                                      education) %>% 
  select(Demography, everything())

# Code to generate a nice LaTex (booktabs style) version

knitr::kable(demographics_latex_table, format = "markdown", booktabs = TRUE) # <- for latex change argument to: format = "latex

```

## Certainty level distribution (Table 2)

```{r certainty level}

flu_data %>% 
  saridr::prop(certainty, leave_n = T)

```

## Examing the level of certainty level as a function of treatment type

We show the distribution of certainty level as a function of the treatment presented to the respondents. This chart did not make it into the manuscript.

```{r certainty versus treatment}

ggplot(flu_data, aes(certainty)) + 
  geom_histogram(bins = 5) + 
  facet_wrap(~treatment)

```

We want to make sure that the treatment type did not affect the reported certainty level, via $\chi^2$ test.

```{r certainty distribution versus treatment}
flu_data %>% 
  count(treatment, certainty) %>% 
  pivot_wider(id_cols = treatment, names_from = certainty, values_from = n, values_fill = list(n=0)) %>% 
  column_to_rownames(var = "treatment") %>% 
  as.matrix() %>% 
  chisq.test()
```

## Effect of treatment split by certain/uncertain (Table 3) 

The table compares the effect of the treatment by certainty level.

```{r treatment by certainty}
total_vaccinated <- flu_data %>% 
  group_by(treatment) %>% 
  summarize(tot_vaccinated = mean(action_binary)) %>% 
  spread(treatment, tot_vaccinated) %>% 
  mutate(certainty = NA)

# table in percentages (commented out)

# flu_data %>% 
#   group_by(treatment, certainty) %>% 
#   summarize(prop_vaccinated = mean(action_binary)) %>% 
#   spread(treatment, prop_vaccinated) %>% 
#   bind_rows(total_vaccinated) %>% 
#   knitr::kable()

# Table in absolute numbers (commented out)

# flu_data %>% 
#   group_by(treatment, certainty) %>% 
#   summarize(prop_vaccinated = mean(action_binary),
#             vaccinated_abs = sum(action_binary),
#             total_cell = n()) %>% 
#   mutate(tbl_val = paste0(round(prop_vaccinated*100), "% (", vaccinated_abs, "/", total_cell, ")")) %>% 
#   select(treatment, certainty, tbl_val) %>% 
#   spread(treatment, tbl_val) %>% 
#   knitr::kable(format = "latex")
  
# Splitting the certainty to two levels (<=3 versus >=4)
flu_data %>% 
  mutate(certainty_binary = certainty <= 3) %>% 
  group_by(treatment, certainty_binary) %>% 
  summarize(prop_vaccinated = mean(action_binary),
            vaccinated_abs = sum(action_binary),
            total_cell = n()) %>% 
  mutate(tbl_val = paste0(round(prop_vaccinated*100, 1), "% (", vaccinated_abs, "/", total_cell, ")")) %>% 
  select(treatment, certainty_binary, tbl_val) %>% 
  spread(treatment, tbl_val) %>% 
  mutate(certainty_binary = ifelse(certainty_binary, "Uncertain", "Certain")) %>% 
  knitr::kable()

# figure of vaccinations
intentions_for_plot <- flu_data %>%
  mutate(Certainty = case_when(certainty <= 3 ~ "Uncertain",
                               certainty >= 4 ~ "Certain")) %>% 
  group_by(treatment, Certainty) %>% 
  summarize(Vaccine_next_year = mean(action_binary),
            Vaccin_next_year_sd = sd(action_binary),
            successes = sum(action_binary),
            trials = n()) %>% 
  group_by(treatment, Certainty, Vaccine_next_year, Vaccin_next_year_sd) %>% 
  nest() %>% 
  mutate(confint = map(data, ~{
    propres <- prop.test(.$successes, .$trials)
    tibble(lb = propres$conf.int[1], ub = propres$conf.int[2])
  })) %>% 
  select(-data) %>% 
  unnest(cols = confint) %>% 
  mutate(vaccin_next_sd_minus = Vaccine_next_year - Vaccin_next_year_sd,
         vaccin_next_sd_plus = Vaccine_next_year + Vaccin_next_year_sd)

    
intentions_plot <- ggplot(intentions_for_plot, aes(x = treatment, y = Vaccine_next_year, fill = treatment)) + 
  geom_col(color = "black") +
  facet_grid(rows = vars(Certainty)) + 
  theme_bw() + 
  geom_errorbar(aes(ymin = lb, ymax = ub), size = 1) +
  scale_y_continuous(labels = scales::percent_format(1)) + 
  ylab("Intentions to vaccinate") + 
  xlab("Treatment") + 
  guides(fill = guide_legend("Treatment"))
  
intentions_plot

# export
#ggsave(filename = "data/intentions_plot.png", intentions_plot, width = 20, height = 10, units = "cm")

```

## Multiple comparison using Mann-Whitney-Wilcoxon

```{r mann whitney wilcoxon}

provide_p_value_MWW <- function(data, treatment_filter){
  tmp <- data %>% 
    filter(treatment %in% c("Control", treatment_filter)) %>% 
    wilcox.test(formula = action_binary ~ treatment, data = .)
  
  tmp$p.value
}

tibble(treatments = c("Recommendation", "Stock", "Cost", "Benefit")) %>% 
  mutate(p.values = map_dbl(treatments, 
                            ~{provide_p_value_MWW(data = flu_data %>% filter(certainty <= 3),
                                                  treatment_filter = .)})) %>% 
  mutate(respondents = "uncertain") %>% 
  bind_rows(
    tibble(treatments = c("Recommendation", "Stock", "Cost", "Benefit")) %>% 
  mutate(p.values = map_dbl(treatments, 
                            ~{provide_p_value_MWW(data = flu_data %>% filter(certainty >= 4),
                                                  treatment_filter = .)})) %>% 
  mutate(respondents = "certain")
  ) %>% 
  bind_rows(
    tibble(treatments = c("Recommendation", "Stock", "Cost", "Benefit")) %>% 
      mutate(p.values = map_dbl(treatments, 
                                ~{provide_p_value_MWW(data = flu_data,
                                                      treatment_filter = .)})) %>% 
      mutate(respondents = "overall")
  ) %>% 
  mutate(fdr_adjusted = p.adjust(p.values, method = "fdr"))

```

## Cohen's d computation

Effect size for the treatment effect (for the uncertain type).

```{r comparison of control versus treatment among uncertain}

effsize::cohen.d(formula = action_binary ~ treatment,
                 data = flu_data %>% 
                   filter(certainty <= 3) %>% 
                   filter(treatment %in% c("Control", "Recommendation")) %>%
                   mutate(treatment = as.character(treatment)))

effsize::cohen.d(formula = action_binary ~ treatment,
                 data = flu_data %>% 
                   filter(certainty <= 3) %>% 
                   filter(treatment %in% c("Control", "Stock")) %>%
                   mutate(treatment = as.character(treatment)))

effsize::cohen.d(formula = action_binary ~ treatment,
                 data = flu_data %>% 
                   filter(certainty <= 3) %>% 
                   filter(treatment %in% c("Control", "Cost")) %>%
                   mutate(treatment = as.character(treatment)))

effsize::cohen.d(formula = action_binary ~ treatment,
                 data = flu_data %>% 
                   filter(certainty <= 3) %>% 
                   filter(treatment %in% c("Control", "Benefit")) %>%
                   mutate(treatment = as.character(treatment)))

```

## Effect of treatment split by number of vaccinations in the last 5 years (Table 4)

```{r treatment by vaccination history}
total_vaccinated <- flu_data %>% 
  group_by(treatment) %>% 
  summarize(tot_vaccinated = mean(action_binary)) %>% 
  spread(treatment, tot_vaccinated) %>% 
  mutate(five_years_vaccinations = NA)

flu_data %>% 
  group_by(treatment, five_years_vaccinations) %>% 
  summarize(prop_vaccinated = mean(action_binary)) %>% 
  spread(treatment, prop_vaccinated) %>% 
  bind_rows(total_vaccinated) %>% 
  mutate_at(vars(2:6), ~paste0(round(.*100), "%")) %>% 
  knitr::kable()
  

```

## Logistic regression of intentions to vaccinate

A logistic regression model of intentions to receive the vaccination.

```{r logistic regression model nominal}

flu_data_for_glm <- flu_data %>% 
  # mutate(treatment = fct_relevel(treatment, "Control", after = 4)) %>% 
  mutate(uncertain = certainty <= 3)

vaccination_glm0 <- glm(data = flu_data_for_glm, family = binomial, 
                        formula = action_binary ~ treatment)

summary(vaccination_glm0)
```

The same model, with interaction of traetment*certainty

```{r logistic regression with uncertain interaction}

vaccination_glm1 <- glm(data = flu_data_for_glm, family = binomial, 
                        formula = action_binary ~ treatment + uncertain + treatment*uncertain)

summary(vaccination_glm1)

```

A complete model including background demographic variables and vaccinated last.

```{r logistic regression with uncertain interaction and demography}

vaccination_glm2 <- glm(data = flu_data_for_glm, family = binomial, 
                        formula = action_binary ~ 
                          treatment + uncertain + treatment*uncertain + 
                          last_year_vaccination + gender + age + income + education)

summary(vaccination_glm2)

```

The code to generate a stargazer latex table.

```{r regression output}
## Disable/enable according to need.
# stargazer::stargazer(vaccination_glm0, 
#                      vaccination_glm1,
#                      vaccination_glm2,
#                      type = "latex")

```

## Open ended question - content analysis

```{r comparison comments vs treatment}
open_ended <- read_csv("data/open_ended_content_analysis.csv", skip = 1,
                       col_names = c("id", "comparison", "spam")) %>% 
  mutate_all(~ifelse(is.na(.), 0, .))

flu_data %>% 
  left_join(open_ended) %>% 
  group_by(treatment) %>% 
  summarize(portion_comparison = mean(comparison))

```

## Analysis provided in the supplementary material

Additional crosstabulations and statistical analysis in higher resolution.

### Effect of treatment by certainty level (1-5)

```{r effect treatement by certainty levels}
flu_data %>%
  group_by(treatment, certainty) %>%
  summarize(prop_vaccinated = mean(action_binary)) %>%
  spread(treatment, prop_vaccinated) %>%
  bind_rows(total_vaccinated %>% select(-five_years_vaccinations)) %>%
  knitr::kable()
```

## Validation check

We check for the following inconsistencies:

   * Respondents which checked the "vaccinated last year", but have less than 1 vaccinations in the last 5 years.
   * Respondents which did not check the "vaccinated last year", but have 5 vaccinations in the last 5 years.

```{r validation check}

flu_data %>% 
  filter(last_year_vaccine == 1 & five_years_vaccinations == 0 | 
           last_year_vaccination == 0 & five_years_vaccinations == 5)

```

There are only 3 such inconsistencies, after reading their open-ended action explanation, they all seem to be answering seriously, so we decided to keep them.

## Number of late vaccinations per treatment

The examines the number of late vaccinations in each treatment group.

```{r late vaccinations}

flu_data %>% 
  group_by(treatment) %>% 
  saridr::prop(action_recoded) %>% 
  pivot_wider(id_cols = treatment, names_from = action_recoded, values_from = c(prop)) %>% 
  knitr::kable("markdown")

flu_data %>% 
  group_by(treatment) %>% 
  count(action_recoded) %>% 
  pivot_wider(id_cols = treatment, names_from = action_recoded, values_from = n) %>% 
  knitr::kable("markdown")


```

## Open ended content analysis

```{r open ended}

open_ended %>% 
  count(spam)

open_ended %>% 
  count(comparison)

```

## Distribution of the sample by age


```{r distribution sample age}

flu_data %>% saridr::prop(age_group, leave_n = T)
  
```

## Additional analysis

### Time to complete questionnaire

```{r time to complete}
complete_duration <- flu_data %>% 
  mutate_at(vars(started, submitted), ~lubridate::dmy_hms(.)) %>% 
  mutate(duration = submitted - started) %>% 
  select(id, duration) %>% 
  mutate(duration_groups = cut(as.numeric(duration), c(0, 30, 60, 120, 500, 10000)))

ggplot(complete_duration, aes(duration)) + 
  stat_ecdf() + 
  theme_bw() + 
  coord_cartesian(xlim = c(0, 500))

quantile(complete_duration$duration, c(0.05, 0.95))

ggplot(complete_duration, aes(duration)) + 
  geom_histogram(bins = 30) + 
  scale_x_continuous(limits = c(0, 500))

complete_duration %>% 
  count(duration_groups) %>% 
  mutate(prop = n/sum(n))

```

### Examine correlation of number of vaccinations versus certainty

We examine the relationship between the number of vaccinations in the last 5 years and the certainty level. Logic dictates that respondents which vaccinated 5 times or 0 times are much more "certain" than those who vaccinated 1-4 times.



```{r vaccination history and certainty}
history_vs_certainty <- flu_data %>% 
  mutate(vaccination_history = case_when(five_years_vaccinations %in% c(5) ~ 3,
                                         five_years_vaccinations %in% c(0:2) ~ 1,
                                         five_years_vaccinations %in% c(3:4) ~ 2)) %>% 
  mutate(certainty_3_levels = case_when(certainty >=4 ~ 3,
                                        certainty == 3 ~ 2,
                                        certainty <= 2 ~ 1))

cor(history_vs_certainty %>%
      select(five_years_vaccinations, certainty, certainty_3_levels, vaccination_history)) %>% 
  knitr::kable()
```